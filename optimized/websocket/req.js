(function(){function y(e,n,i){var f=this;f.socket=e,f.httpRequest=n,f.resource=n.url,f.remoteAddress=e.remoteAddress,f.cfg=i,f.readHandshake=function(){var e=f.httpRequest;f.resourceURL=r.parse(f.resource,!0),f.host=e.headers.host,f.key=e.headers["sec-websocket-key"],f.origin=e.headers.origin;var t=e.headers["sec-websocket-protocol"];t?f.requestedProtocols=t.toLocaleLowerCase().split(o):f.requestedProtocols=[],e.headers["x-forwarded-for"]&&(f.remoteAddress=e.headers["x-forwarded-for"].split(", ")[0]);var n=e.headers["sec-websocket-extensions"];f.requestedExtensions=f.parseExtensions(n);var i=e.headers.cookie;f.cookies=f.parseCookies(i)},f.parseExtensions=function(e){return!e||e.length===0?[]:(extensions=e.toLocaleLowerCase().split(o),extensions.forEach(function(e,t,n){var r=e.split(u),i=r[0],s=r.slice(1);s.forEach(function(e,t,n){var r=e.split("="),i={name:r[0],value:r[1]};n.splice(t,1,i)});var o={name:i,params:s};n.splice(t,1,o)}),extensions)},f.parseCookies=function(e){if(!e||e.length===0)return[];var t=[],n=e.split(v);return n.forEach(function(e){if(e&&e.length!==0){var n=e.match(m);t.push({name:n[1],value:n[2]})}}),t},f.accept=function(e,n,r){var i=new s(f.socket,[],e,!1,f.cfg);i.remoteAddress=f.remoteAddress;var o=t.createHash("sha1");o.update(f.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var u=o.digest("base64"),l="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "+u+"\r\n";return n&&(n=n.replace(a,""),l+="Origin: "+n+"\r\n"),l+="\r\n",f.socket.write(l,"ascii"),f.emit("requestAccepted",i),i},f.reject=function(e){f.socket.end("HTTP/1.1 "+e+"\r\nConnection: close\r\n\r\n","ascii"),f.emit("requestRejected",this)}}var e=require,t=e("crypto"),n=e("util"),r=e("url"),i=e("events").EventEmitter,s=e("./conn"),o=/,\s*/,u=/;\s*/,a=/[\r\n]/g,f=["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," ",String.fromCharCode(9)],l=[String.fromCharCode(127)],c=/([\x00-\x20\x22\x28\x29\x2c\x2f\x3a-\x3f\x40\x5b-\x5e\x7b\x7d\x7f])/,h=/[^\x21\x23-\x2b\x2d-\x3a\x3c-\x5b\x5d-\x7e]/,p=/^"[^"]*"$/,d=/[\x00-\x20\x3b]/g,v=/; */,m=/(.*?)=(.*)/;for(var g=0;g<31;g++)l.push(String.fromCharCode(g));n.inherits(y,i),module.exports=y})()