(function(){function v(e){var n=this;n.connect=function(e,n,r,o){function d(e){u.emit("connectFailed",e)}var u=this;typeof n=="string"&&(n=[n]),n instanceof Array||(n=[]),this.protocols=n,this.origin=r,typeof e=="string"?this.url=s.parse(e):this.url=e,this.secure=this.url.protocol==="wss:";var a={"ws:":"80","wss:":"443"};this.url.port||(this.url.port=a[this.url.protocol]);var f=new Buffer(16);for(var l=0;l<16;l++)f[l]=Math.round(Math.random()*255);this.base64nonce=f.toString("base64");var c=this.url.hostname;if(this.url.protocol==="ws:"&&this.url.port!=="80"||this.url.protocol==="wss:"&&this.url.port!=="443")c+=":"+this.url.port;var h={};t(h,o||{}),t(h,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Version":"13","Sec-WebSocket-Key":this.base64nonce,Host:c}),this.protocols.length>0&&(h["Sec-WebSocket-Protocol"]=this.protocols.join(", ")),this.origin&&(h.Origin=this.origin);var p=this.url.pathname;this.url.search&&(p+=this.url.search);var v={hostname:this.url.hostname,port:this.url.port,method:"GET",path:p,headers:h,agent:!1},m=i.request(v);m.on("upgrade",function(t,n,r){m.removeListener("error",d),u.socket=n,u.response=t,u.firstDataChunk=r,u.validateHandshake()}),m.on("error",d),m.on("response",function(e){u.failHandshake("Server responded with a non-101 status: "+e.statusCode)}),m.end()},n.validateHandshake=function(){var e=this.response.headers;if(this.protocols.length>0){this.protocol=e["sec-websocket-protocol"];if(!this.protocol){this.failHandshake("Expected a Sec-WebSocket-Protocol header.");return}if(this.protocols.indexOf(this.protocol)===-1){this.failHandshake("Server did not respond with a requested protocol.");return}}if(!e.connection||e.connection.toLocaleLowerCase()!=="upgrade"){this.failHandshake("Expected a Connection: Upgrade header from the server");return}if(!e.upgrade||e.upgrade.toLocaleLowerCase()!=="websocket"){this.failHandshake("Expected an Upgrade: websocket header from the server");return}var t=o.createHash("sha1");t.update(this.base64nonce+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var n=t.digest("base64");if(!e["sec-websocket-accept"]){this.failHandshake("Expected Sec-WebSocket-Accept header from server");return}if(e["sec-websocket-accept"]!==n){this.failHandshake("Sec-WebSocket-Accept header from server didn't match expected value of "+n);return}this.succeedHandshake()},n.failHandshake=function(e){this.socket&&this.socket.writable&&this.socket.end(),this.emit("connectFailed",e)},n.succeedHandshake=function(){var e=new u(this.socket,[],this.protocol,!0,this.config);this.emit("connect",e),this.firstDataChunk.length>0&&(e.data(this.firstDataChunk),this.firstDataChunk=null)},n.config={maxReceivedFrameSize:1048576,maxReceivedMessageSize:8388608,fragmentOutgoingMessages:!0,fragmentationThreshold:16384,assembleFragments:!0,closeTimeout:5e3,tlsOptions:{}},e&&t(this.config,e),this.readyState=a}var e=require,t=e("./utils").extend,n=e("util"),r=e("events").EventEmitter,i=e("http"),s=e("url"),o=e("crypto"),u=e("./WebSocketConnection");const a=-1,f=0,l=1,c=2,h=3;var p=0,d=["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," ",String.fromCharCode(9)];n.inherits(v,r),module.exports=v})()