(function(){function o(e,t,o,u,a){var f=this,l=!1,c=[],h=0;f.config=a,f.extensions=t,f.remoteAddress=e.remoteAddress,f.closeReasonCode=-1,f.maskOutgoingPackets=u,f.maskBytes=new Buffer(4),f.frameHeader=new Buffer(10),f.bufferList=new r,f.currentFrame=new n(f.maskBytes,f.frameHeader,f.config),f.frameQueue=[],f.connected=!0,f.state="open",f.waitingForCloseResponse=!1,f.closeTimeout=f.config.closeTimeout,f.maxReceivedMessageSize=f.config.maxReceivedMessageSize,f.data=function(e){f.bufferList.write(e);while(f.connected&&f.currentFrame.addData(f.bufferList)){if(f.currentFrame.protocolError){f.drop(1002,f.currentFrame.dropReason);return}f.emit("frame",f.currentFrame),f.processFrame(f.currentFrame),f.currentFrame=new n(f.maskBytes,f.frameHeader,f.config)}},f.error=function(t){f.listeners("error").length>0&&f.emit("error",t),e.end()},f.end=function(){e.end(),f.frameQueue=null,c=[],f.bufferList=null},f.close=function(e){f.socketHadError=e,f.connected=!1,f.state=s,f.closeEventEmitted||(f.closeEventEmitted=!0,f.emit("close",f.closeReasonCode)),f.clearCloseTimer()},f.drain=function(){l=!1,f.processOutgoingFrameQueue()},f.close=function(){f.connected&&(f.closeReasonCode=1e3,f.setCloseTimer(),f.sendCloseFrame(),f.state=i,f.connected=!1)},f.drop=function(t,n,r){typeof t!="number"&&(t=1002),f.closeReasonCode=t,c=[],f.frameQueue=[],r||f.sendCloseFrame(t,"",!0),f.connected=!1,f.state=s,f.closeEventEmitted=!0,f.emit("close",t,""),e.destroy()},f.setCloseTimer=function(){f.clearCloseTimer(),f.waitingForCloseResponse=!0,f.closeTimer=setTimeout(f._closeTimerHandler,f.closeTimeout)},f.clearCloseTimer=function(){f.closeTimer&&(clearTimeout(f.closeTimer),f.waitingForCloseResponse=!1,f.closeTimer=null)},f.handleCloseTimer=function(){f.closeTimer=null,f.waitingForCloseResponse&&(f.waitingForCloseResponse=!1,e.end())},f.processFrame=function(t){var n,r;switch(t.opcode){case 1:f.emit("message",{type:"utf8",utf8Data:t.binaryPayload.toString("utf8")});break;case 9:break;case 10:break;case 8:if(f.waitingForCloseResponse)f.clearCloseTimer(),f.waitingForCloseResponse=!1,f.state=s,e.end();else{f.state=i;var o;t.invalidCloseFrameLength?(f.closeReasonCode=1005,o=1002):t.closeStatus===-1?(f.closeReasonCode=t.closeStatus,o=1e3):(f.closeReasonCode=t.closeStatus,o=1002),f.sendCloseFrame(o),e.end(),f.connected=!1}break;default:f.drop(1002)}},f.send=function(e,t){var r=new n(f.maskBytes,f.frameHeader,f.config);r.opcode=1,r.binaryPayload=new Buffer(e.toString(),"utf8"),f.fragmentAndSend(r,t)},f.fragmentAndSend=function(e,t){var n=e.binaryPayload.length;e.fin=!0,f.sendFrame(e,t)},f.sendCloseFrame=function(e,t,r){typeof e!="number"&&(e=1e3);var i=new n(f.maskBytes,f.frameHeader,f.config);i.fin=!0,i.opcode=8,i.closeStatus=e,typeof t=="string"&&(i.binaryPayload=new Buffer(t,"utf8")),f.sendFrame(i,r)},f.sendFrame=function(e,t,n){typeof t=="function"&&(n=t,t=!1),e.mask=f.maskOutgoingPackets;var r=e.toBuffer();c.unshift([r,n]),h+=r.length,(!l||t)&&f.processOutgoingFrameQueue()},f.processOutgoingFrameQueue=function(){if(l)return;if(c.length>0){var t=c.pop(),n=t[0],r=t[1];if(!f.connected&&typeof r=="function"){r("closed");return}try{var i=e.write(n,r)}catch(s){typeof r=="function"&&r(s.toString()),f.listeners("error").length>0&&f.emit("error","Error while writing to socket: "+s.toString());return}h-=n.length;if(!i){l=!0;return}process.nextTick(outgoingFrameQueueHandler)}},e.removeAllListeners("error"),e.on("error",f.error.bind(this)),e.on("data",f.data.bind(this)),e.on("end",f.end.bind(this)),e.on("close",f.close.bind(this)),e.on("drain",f.drain.bind(this)),e.setNoDelay(!0),outgoingFrameQueueHandler=f.processOutgoingFrameQueue.bind(this),f._closeTimerHandler=f.handleCloseTimer.bind(this)}var e=require,t=e("./u"),n=e("./frame"),r=e("./list"),i="closing",s="closed";t.in(o,t.em),module.exports=o})()