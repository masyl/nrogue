(function(){function u(e,t,n,u,a){var f=this;f.config=a,f.socket=e,f.protocol=n,f.extensions=t,f.remoteAddress=e.remoteAddress,f.closeReasonCode=-1,f.maskOutgoingPackets=u,f.maskBytes=new Buffer(4),f.frameHeader=new Buffer(10),f.bufferList=new i,f.currentFrame=new r(f.maskBytes,f.frameHeader,f.config),f.fragmentationSize=0,f.frameQueue=[],f.connected=!0,f.state="open",f.waitingForCloseResponse=!1,f.closeTimeout=f.config.closeTimeout,f.assembleFragments=f.config.assembleFragments,f.maxReceivedMessageSize=f.config.maxReceivedMessageSize,f.data=function(e){f.bufferList.write(e);while(f.connected&&f.currentFrame.addData(f.bufferList)){if(f.currentFrame.protocolError){f.drop(1002,f.currentFrame.dropReason);return}f.assembleFragments||f.emit("frame",f.currentFrame),f.processFrame(f.currentFrame),f.currentFrame=new r(f.maskBytes,f.frameHeader,f.config)}},f.error=function(e){f.listeners("error").length>0&&f.emit("error",e),f.socket.end()},f.end=function(){f.socket.end(),f.frameQueue=null,f.outgoingFrameQueue=[],f.fragmentationSize=0,f.bufferList=null},f.close=function(e){f.socketHadError=e,f.connected=!1,f.state=o,f.closeReasonCode===-1&&(f.closeReasonCode=1006),f.closeEventEmitted||(f.closeEventEmitted=!0,f.emit("close",f.closeReasonCode)),f.clearCloseTimer()},f.drain=function(){f.outputPaused=!1,f.processOutgoingFrameQueue()},f.close=function(){f.connected&&(f.closeReasonCode=1e3,f.setCloseTimer(),f.sendCloseFrame(),f.state=s,f.connected=!1)},f.drop=function(e,t,n){typeof e!="number"&&(e=1002),f.closeReasonCode=e,f.outgoingFrameQueue=[],f.frameQueue=[],f.fragmentationSize=0,n||f.sendCloseFrame(e,"",!0),f.connected=!1,f.state=o,f.closeEventEmitted=!0,f.emit("close",e,""),f.socket.destroy()},f.setCloseTimer=function(){f.clearCloseTimer(),f.waitingForCloseResponse=!0,f.closeTimer=setTimeout(f._closeTimerHandler,f.closeTimeout)},f.clearCloseTimer=function(){f.closeTimer&&(clearTimeout(f.closeTimer),f.waitingForCloseResponse=!1,f.closeTimer=null)},f.handleCloseTimer=function(){f.closeTimer=null,f.waitingForCloseResponse&&(f.waitingForCloseResponse=!1,f.socket.end())},f.processFrame=function(e){var t,n;switch(e.opcode){case 2:f.assembleFragments&&(e.fin?f.emit("message",{type:"binary",binaryData:e.binaryPayload}):(f.frameQueue.push(e),f.fragmentationSize=e.length));break;case 1:f.assembleFragments&&(e.fin?f.emit("message",{type:"utf8",utf8Data:e.binaryPayload.toString("utf8")}):(f.frameQueue.push(e),f.fragmentationSize=e.length));break;case 0:if(f.assembleFragments){f.fragmentationSize+=e.length,f.frameQueue.push(e);if(e.fin){var r=0,i=new Buffer(f.fragmentationSize);f.frameQueue.forEach(function(e){e.binaryPayload.copy(i,r),r+=e.binaryPayload.length});switch(f.frameQueue[0].opcode){case 2:f.emit("message",{type:"binary",binaryData:i});break;case 1:f.emit("message",{type:"utf8",utf8Data:i.toString("utf8")});break;default:f.drop(1002);return}f.frameQueue=[],f.fragmentationSize=0}}break;case 9:break;case 10:break;case 8:if(f.waitingForCloseResponse)f.clearCloseTimer(),f.waitingForCloseResponse=!1,f.state=o,f.socket.end();else{f.state=s;var u;e.invalidCloseFrameLength?(f.closeReasonCode=1005,u=1002):e.closeStatus===-1?(f.closeReasonCode=e.closeStatus,u=1e3):(f.closeReasonCode=e.closeStatus,u=1002),f.sendCloseFrame(u),f.socket.end(),f.connected=!1}break;default:f.drop(1002)}},f.send=function(e,t){var n=new r(f.maskBytes,f.frameHeader,f.config);n.opcode=1,n.binaryPayload=new Buffer(e.toString(),"utf8"),f.fragmentAndSend(n,t)},f.fragmentAndSend=function(e,t){if(e.opcode>7)throw new Error("You cannot fragment control frames.");var n=f.config.fragmentationThreshold,i=e.binaryPayload.length;if(f.config.fragmentOutgoingMessages&&e.binaryPayload&&i>n){var s=Math.ceil(i/n),o=0,u=function(e){if(e){typeof t=="function"&&(t(e),t=null);return}++o,typeof t=="function"&&o===s&&t()};for(var a=1;a<=s;a++){var l=new r(f.maskBytes,f.frameHeader,f.config);l.opcode=a===1?e.opcode:0,l.fin=a===s;var c=a===s?i-n*(a-1):n,h=n*(a-1);l.binaryPayload=e.binaryPayload.slice(h,h+c),f.sendFrame(l,u)}}else e.fin=!0,f.sendFrame(e,t)},f.sendCloseFrame=function(e,t,n){typeof e!="number"&&(e=1e3);var i=new r(f.maskBytes,f.frameHeader,f.config);i.fin=!0,i.opcode=8,i.closeStatus=e,typeof t=="string"&&(i.binaryPayload=new Buffer(t,"utf8")),f.sendFrame(i,n)},f.sendFrame=function(e,t,n){typeof t=="function"&&(n=t,t=!1),e.mask=f.maskOutgoingPackets;var r=e.toBuffer();f.outgoingFrameQueue.unshift([r,n]),f.bytesWaitingToFlush+=r.length,(!f.outputPaused||t)&&f.processOutgoingFrameQueue()},f.processOutgoingFrameQueue=function(){if(f.outputPaused)return;if(f.outgoingFrameQueue.length>0){var e=f.outgoingFrameQueue.pop(),t=e[0],n=e[1];if(!f.connected&&typeof n=="function"){n("closed");return}try{var r=f.socket.write(t,n)}catch(i){typeof n=="function"&&n(i.toString()),f.listeners("error").length>0&&f.emit("error","Error while writing to socket: "+i.toString());return}f.bytesWaitingToFlush-=t.length;if(!r){f.outputPaused=!0;return}process.nextTick(f.outgoingFrameQueueHandler)}},f.socket.removeAllListeners("error"),f.socket.on("error",f.error.bind(this)),f.socket.on("data",f.data.bind(this)),f.socket.on("end",f.end.bind(this)),f.socket.on("close",f.close.bind(this)),f.socket.on("drain",f.drain.bind(this)),f.socket.setNoDelay(!0),f.outgoingFrameQueue=[],f.outputPaused=!1,f.outgoingFrameQueueHandler=f.processOutgoingFrameQueue.bind(this),f.bytesWaitingToFlush=0,f._closeTimerHandler=f.handleCloseTimer.bind(this)}var e=require,t=e("util"),n=e("events").EventEmitter,r=e("./frame"),i=e("./list"),s="closing",o="closed";t.inherits(u,n),module.exports=u})()