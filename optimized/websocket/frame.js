(function(){function e(e,t,n){this.maskBytes=e,this.frameHeader=t,this.config=n,this.maxReceivedFrameSize=n.maxReceivedFrameSize,this.protocolError=!1,this.frameTooLarge=!1,this.invalidCloseFrameLength=!1,this.parseState=1,this.closeStatus=-1}function t(e,t,n){var r=e.length;typeof n!="number"&&(n=0);for(var i=0;i<r;i++)e[i]=e[i]^t[n],n=n+1&3;return n}function n(e,t){var n=0;return n=e[t]<<8,n|=e[t+1],n}function r(e,t){var n=new Array(2);return n[0]=ruint32(e,t),n[1]=ruint32(e,t+4),n}function i(e,t,n){t[n]=(e&65280)>>>8,t[n+1]=e&255}function s(e,t,n){t[n]=(e-(e&16777215))/Math.pow(2,24),t[n+1]=e>>>16&255,t[n+2]=e>>>8&255,t[n+3]=e&255}function o(e,t,n){s(e[0],t,n),s(e[1],t,n+4)}e.prototype.addData=function(e,i){var s;if(this.parseState===1&&e.length>=2){e.joinInto(this.frameHeader,0,0,2),e.advance(2);var o=this.frameHeader[0],u=this.frameHeader[1];this.fin=Boolean(o&128),this.rsv1=Boolean(o&64),this.rsv2=Boolean(o&32),this.rsv3=Boolean(o&16),this.mask=Boolean(u&128),this.opcode=o&15,this.length=u&127,this.length===126?this.parseState=2:this.length===127?this.parseState=3:this.parseState=4}if(this.parseState===2)e.length>=2&&(e.joinInto(this.frameHeader,2,0,2),e.advance(2),this.length=n(this.frameHeader,2),this.parseState=4);else if(this.parseState===3&&e.length>=8){e.joinInto(this.frameHeader,2,0,8),e.advance(8);var a=r(this.frameHeader,2);if(a[0]!==0)return this.protocolError=!0,this.dropReason="Unsupported 64-bit length frame received",!0;this.length=a[1],this.parseState=4}this.parseState===4&&(this.mask?e.length>=4&&(e.joinInto(this.maskBytes,0,0,4),e.advance(4),this.parseState=5):this.parseState=5);if(this.parseState===5){if(this.length>this.maxReceivedFrameSize)return this.frameTooLarge=!0,this.dropReason="Frame size of "+this.length.toString(10)+" bytes exceeds maximum accepted frame size",!0;if(this.length===0)return this.binaryPayload=new Buffer(0),this.parseState=6,!0;if(e.length>=this.length)return this.binaryPayload=e.take(this.length),e.advance(this.length),this.mask&&t(this.binaryPayload,this.maskBytes,0),this.opcode===8&&(this.length===1&&(this.binaryPayload=new Buffer(0),this.invalidCloseFrameLength=!0),this.length>=2&&(this.closeStatus=n(this.binaryPayload,0),this.binaryPayload=this.binaryPayload.slice(2))),this.parseState=6,!0}return!1},e.prototype.throwAwayPayload=function(e){return e.length>=this.length?(e.advance(this.length),this.parseState=6,!0):!1},e.prototype.toBuffer=function(e){var n,r=2,u,a,f=0,l=0;this.fin&&(f|=128),this.rsv1&&(f|=64),this.rsv2&&(f|=32),this.rsv3&&(f|=16),this.mask&&(l|=128),f|=this.opcode&15,this.opcode===8?(this.length=2,this.binaryPayload&&(this.length+=this.binaryPayload.length),u=new Buffer(this.length),i(this.closeStatus,u,0),this.length>2&&this.binaryPayload.copy(u,2)):this.binaryPayload?(u=this.binaryPayload,this.length=u.length):this.length=0,this.length<=125?l|=this.length&127:this.length>125&&this.length<=65535?(l|=126,r+=2):this.length>65535&&(l|=127,r+=8);var c=new Buffer(this.length+r+(this.mask?4:0));return c[0]=f,c[1]=l,a=2,this.length>125&&this.length<=65535?(i(this.length,c,a),a+=2):this.length>65535&&(o([0,this.length],c,a),a+=8),this.length>0&&(this.mask?(e?n=0:n=parseInt(Math.random()*4294967295),s(n,this.maskBytes,0),this.maskBytes.copy(c,a),a+=4,u.copy(c,a),t(c.slice(a),this.maskBytes,0)):u.copy(c,a)),c},e.prototype.toString=function(){return"Opcode: "+this.opcode+", fin: "+this.fin+", length: "+this.length+", hasPayload: "+Boolean(this.binaryPayload)+", masked: "+this.mask},module.exports=e})()