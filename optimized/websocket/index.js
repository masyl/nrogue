(function(){var e=require,t=e("./u").extend,n=e("./req"),r=e("util"),i=function(r){function o(e,t,r){var s=new n(t,e,i.config);try{s.readHandshake()}catch(o){s.reject(o.httpCode||400);return}s.once("requestAccepted",u.bind(i)),s.accept(s.requestedProtocols[0],s.origin)}function u(e){var t=this;e.once("close",function(n,r){t.close(e,n,r)}),s.push(e),i.emit("connect",e)}var i=this,s=[];i.unmount=function(){i.config.httpServer.removeListener("upgrade",o.bind(i))},i.close=function(e,t,n){var r=s.indexOf(e);r!==-1&&s.splice(r,1),i.emit("close",e,t,n)},i.closeAll=function(){s.forEach(function(e){e.close()})},i.broadcast=function(e){s.forEach(function(e){e.send(utfData)})},i.shutDown=function(){i.unmount(),i.closeAll()},i.mount=function(e){i.config={httpServer:null,maxReceivedFrameSize:65536,maxReceivedMessageSize:1048576,fragmentOutgoingMessages:!0,fragmentationThreshold:16384,assembleFragments:!0,closeTimeout:5e3},t(i.config,e),i.config.httpServer.on("upgrade",o.bind(i))},r&&i.mount(r)};r.inherits(i,e("events").EventEmitter),module.exports=i})()