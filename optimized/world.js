(function(){var e=require("./g"),t=require("./z").ai,n=require("./agent"),r=require("./types"),i=require("./map");module.exports=function(o,u,a,f){var l=this,c=0;l.age=0,l.tps=1,l.sps=60,l.density=f||1,l.width=o||30,l.height=u||30,l.types=r,l.map=i(l),l.agents={},l.agentsCount=0,l.datetime=new Date,l.sunlight=1,l.spawnZombie=function(){l.spawn(null,t.zombie,function(e){e.type="zombie",e.health=500,e.visionRange=50,e.attackRange=1,e.attackSize=1,e.attackStrength=50})},l.spawn=function(t,r,i){function o(t){var n,r,i;if(t.attack)for(r in l.agents){n=l.agents[r];var i=e.dist(t.attack,n);i<s.attackSize&&(n.health+=-s.attackStrength),n.health<=0&&s.kills++}if(t.dir!==undefined&&t.dir!==null){var o=t.dir;o<0&&(o=7),o>7&&(o=0),s.dir=o}if(t.walk!=undefined){var u=0,a=0,f=t.walk;f>1&&(f=1),o==0?(u=0,a=-f):o==1?(u=f,a=-f):o==2?(u=f,a=0):o==3?(u=f,a=f):o==4?(u=0,a=f):o==5?(u=-f,a=f):o==6?(u=-f,a=0):o==7&&(u=-f,a=-f);var c,h;c=s.x+u,h=s.y+a,c>=l.width&&(c=l.width-1),c<0&&(c=0),h>=l.height&&(h=l.height-1),h<0&&(h=0);var p=l.map[c+"-"+h];if(p){var d=l.types[p.type];d.solid&&(c=s.x,h=s.y)}if(s.type==="human"){s.vision=s.visionRange*(s.health/1e3);var p=l.map[s.x+"-"+s.y];p&&p.type=="floor"&&(s.health+=10),s.health>1e3&&(s.health=1e3)}s.age=l.age-s.birth,s.x=c,s.y=h}t.next!==undefined&&(s.next=t.next)}function u(){s.type=="zombie"&&l.spawnZombie(),delete l.agents[s.id]}var s;return c++,t?s=new n(l.age,c,e.rnd(l.width-10)+5,e.rnd(l.height-10)+5,t,null,u,o):s=new n(l.age,c,e.rnd(l.width-10)+5,e.rnd(l.height-10)+5,null,r,u,o),i&&i(s),l.agents[s.id]=s,l},l.start=function(e,t){e&&(l.tps=e),t&&(l.spt=t);for(var n=0;n<a;n++)this.spawnZombie();return setInterval(function(){l.tick()},1e3/l.tps),l},l.tick=function(){var e=l.datetime;e.setSeconds(e.getSeconds()+l.spt);var t=new Date,n=e.getHours()+e.getMinutes()/60;l.sunlight=1-Math.abs(n-12)/12,l.age++;for(var r in l.agents)l.agents[r].act(l)}}})()